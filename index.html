<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>canvas clock</title>
		<style type="text/css">
			.clock
			{
				/*
				 -ms-transform: scale(0.5, 0.5);
				 -webkit-transform: scale(0.5, 0.5);
				 transform: scale(0.5, 0.5);
				 */
			}
		</style>
	</head>
	<body>
		<canvas class="clock"
			width="200px"
			height="200px"

			data-seconds-image="img/watchcelona/espacio_tiempo/seconds.png"
			data-minutes-image="img/watchcelona/espacio_tiempo/minutes.png"
			data-hours-image="img/watchcelona/espacio_tiempo/hours.png"
			data-background-image="img/watchcelona/espacio_tiempo/background.png"

			data-seconds-ang="0.5"
			data-minutes-ang="1"
			data-hours-ang="1"

			data-seconds-animation="true"
			data-minutes-animation="true"
			data-hours-animation="true">
		</canvas>

		<script type="text/javascript">
			(function()
			{
				'use strict';

				var clock = function(element)
				{
					var fps = 1000 / 60;
					var ctx = element.getContext('2d');
					var imgs;
					var last_time = {};
					var last_ang = {};
					var draw_position =
					{
						left: element.width / 2,
						top: element.width / 2
					};
					var angs =
					{
						seconds: 0,
						minutes: 0,
						hours: 0
					};

					var _getParams = function(element)
					{
						var params = {};
						var attr = element.attributes;
						var len = attr.length;

						for (var i = 0; i < len; i++)
							params[attr[i]['name']] = attr[i]['value'];

						return params;
					};

					var _getTime = function()
					{
						var now = new Date();
						var t =
						{
							'h' : now.getHours() % 12,
							'm' : now.getMinutes(),
							's' : now.getSeconds(),
							'ms' : Number.parseFloat("0." + now.getMilliseconds().toString().match(/[0-9]{3}/))
							//'ms': 0.000
						};
						return t;
					};

					var _getAng = function(t, type, animate)
					{
						var ang;
						var tmp;
						if (type === 's')
						{
							if (animate)
								tmp = t['s'] + t['ms'];
							else
								tmp = t['s'];

							ang = (tmp * Math.PI / 30) +  angs['seconds'];
						}
						else if (type === 'm')
						{
							if (animate)
								tmp = t['s'];
							else
								tmp = 1;

							ang = (t['m'] * Math.PI / 30) + (tmp * Math.PI / (30 * 60)) + angs['minutes'];
						}
						else if (type === 'h')
						{
							if (animate)
								ang = (t['h'] * Math.PI / 6) + (t['m'] * Math.PI / (6 * 60)) + (t['s'] * Math.PI / (360 * 60)) + angs['hours'];
							else
								ang = t['h'] * Math.PI / 6 + angs['hours'];
						}

						return ang;
					};

					var draw = function()
					{
						var time = _getTime();

						var animate =
						{
							'h' : false,
							'm' : false,
							's' : false
						};

						if (time['h'] !== last_time['h'])
							animate['h'] = true;
						if (time['m'] !== last_time['m'])
							animate['m'] = true;
						if (time['s'] !== last_time['s'])
							animate['s'] = true;

						var h_ang = _getAng(time, 'h', true);
						var m_ang = _getAng(time, 'm', true);
						var s_ang = _getAng(time, 's', true);

						//console.log(s_ang - last_ang['s']);

						//saves the state of canvas
						ctx.save();
						drawBackground();

						//ctx.translate(275, 275);
						ctx.translate(draw_position['left'], draw_position['top']);

						//_drawNumbers();
						drawHour(h_ang);
						drawMinute(m_ang);
						drawSecond(s_ang);

						//restore the state of canva
						ctx.restore();

						// cache params
						last_time = time;
						last_ang =
						{
							'h': h_ang,
							'm': m_ang,
							's': s_ang
						};
					};

					var drawBackground = function()
					{
						//clear the canvas
						ctx.clearRect(0, 0, element.width, element.height);
						ctx.beginPath();
						ctx.rect(0, 0, element.width, element.height);
						ctx.fillStyle = 'grey';
						ctx.fill();

						ctx.drawImage(imgs[3], 0, 0);
					};

					var drawHour = function(h_ang)
					{
						ctx.rotate(h_ang);
						//ctx.drawImage(img[0], -15, -15, 275, 30); //draw the image ;)
						//ctx.drawImage(imgs[0], -15, -15);
						ctx.drawImage(imgs[0], -5, -5);
						//draw the image ;)
						ctx.rotate(-h_ang);
					};

					var drawMinute = function(m_ang)
					{
						ctx.rotate(m_ang);
						//increment the angle and rotate the image
						//ctx.drawImage(img[1], -15, -15, 275, 30); //draw the image ;)
						//ctx.drawImage(imgs[1], -15, -15);
						ctx.drawImage(imgs[1], -5, -5);
						ctx.rotate(-m_ang);
					};

					var drawSecond = function(s_ang)
					{
						ctx.rotate(s_ang);
						//increment the angle and rotate the image
						//ctx.drawImage(img[1], -15, -15, 275, 30); //draw the image ;)
						//ctx.drawImage(imgs[2], -15, -15);
						ctx.drawImage(imgs[2], -50, -50);
						ctx.rotate(-s_ang);
					};

					var _drawNumbers = function()
					{
						var _radius = 275;
						var ang;
						ctx.font = _radius*0.15 + "px arial";
						ctx.fillStyle = "#000000";
						ctx.textBaseline="middle";
						ctx.textAlign="center";

						// orduak
						for(var num = 1; num < 13; num++)
						{
							ang = num * Math.PI / 6;
							ctx.rotate(ang);
							ctx.translate(0, -_radius*0.65);
							ctx.rotate(-ang);
							ctx.fillText(num.toString(), 0, 0);
							ctx.rotate(ang);
							ctx.translate(0, _radius*0.65);
							ctx.rotate(-ang);
						}

						ctx.font = _radius*0.05 + "px arial";

						// minutuak / segunduak
						for(var num = 0; num < 60; num++)
						{
							ang = num * Math.PI / 30;
							ctx.rotate(ang);
							ctx.translate(0, -_radius*0.87);
							ctx.rotate(-ang);
							ctx.fillText(num.toString(), 0, 0);
							ctx.rotate(ang);
							ctx.translate(0, _radius*0.87);
							ctx.rotate(-ang);
						}
					};

					var loop = function()
					{
						draw();
						if(typeof window['requestAnimationFrame']==='function')
							window.requestAnimationFrame(loop);
						else
						{
							window.setTimeout(function()
							{
								loop();
							}, fps);
						}
					};

					var setAngs = function(params)
					{
						if(typeof params['data-hours-ang']!=undefined)
							angs['hours'] = Math.PI * parseFloat(params['data-hours-ang']);
						if(typeof params['data-minutes-ang']!=undefined)
							angs['minutes'] = Math.PI * parseFloat(params['data-minutes-ang']);
						if(typeof params['data-hours-seconds']!=undefined)
							angs['seconds'] = Math.PI * parseFloat(params['data-seconds-ang']);
					};

					var __construct = function(element)
					{
						var params = _getParams(element);
						setAngs(params);

						var images = [params['data-hours-image'], params['data-minutes-image'], params['data-seconds-image'], params['data-background-image']];

						loadImages(images, function(loades_images)
						{
							imgs = loades_images;
							window.requestAnimationFrame(loop);
						});
					};
					__construct(element);
				};

				window['clock'] = clock;
			})();

			(function()
			{
				'use strict';

				var loadImages = function(arr, callback)
				{
					var count = 0;
					var images = [];

					for (var i in arr)
					{
						if (arr[i] !== '')
						{
							images[i] = new Image();
							images[i].onload = function()
							{
								console.log(this.src + " image loaded");
								count++;
							};
							images[i].onerror = function()
							{
								this.setAttribute('data-error', 'true');
								console.log("error loading " + this.src + " image");
								count++;
							};
							images[i].src = arr[i];
						}
						else
						{
							console.log("no image");
							count++;
						}
					}

					var loop = function()
					{
						if (count === arr.length)
						{
							var tmp = [];
							for (var i in images)
							{
								if (images[i].hasAttribute('data-error') === false)
									tmp.push(images[i]);
							}
							callback(tmp);
						}
						else
						{
							window.setTimeout(function()
							{
								loop();
							}, 0);
						}
					};

					loop();
				};
				window['loadImages'] = loadImages;
			})();

			window.onload = function()
			{
				var clocks = document.querySelectorAll('.clock');
				var len = clocks.length;
				for (var i = 0; i < len; i++)
					new clock(clocks[i]);
			};
		</script>
	</body>
</html>
